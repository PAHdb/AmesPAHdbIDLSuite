<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<!-- Generated by IDLdoc 3.6.3 on Wed Apr 27 12:42:55 2022 -->

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
    <title>test_uniqueness.pro (AmesPAHdbIDLSuite Manual)</title>

    
    <link rel="stylesheet" type="text/css" media="all"
          href="../idldoc-resources/main.css" />
    <link rel="stylesheet" type="text/css" media="print"
          href="../idldoc-resources/main-print.css" />
    

    <script type="text/javascript">
      function setTitle() {
        parent.document.title="test_uniqueness.pro (AmesPAHdbIDLSuite Manual)";
      }
    </script>
  </head>

  <body onload="setTitle();" id="root">
    <div class="container">
      <div class="content">
	<code class="source"><span class="comments">; docformat = 'rst'</span>

<span class="comments">;+</span>
<span class="comments">;</span>
<span class="comments">; This is an example testing the uniqueness of a number of randomly</span>
<span class="comments">; generated PAH emission spectra , built around the functionality</span>
<span class="comments">; provided by the AmesPAHdbIDLSuite and should help confirm that the</span>
<span class="comments">; it has been properly installed. The source code is annotated to</span>
<span class="comments">; guide users and developers in the inner workings of the suite.</span>
<span class="comments">;</span>
<span class="comments">; Updated versions of the NASA Ames PAH IR Spectroscopic Database and</span>
<span class="comments">; more information can be found at: `www.astrochemistry.org/pahdb &lt;https://www.astrochemistry.org/pahdb>`.</span>
<span class="comments">;</span>
<span class="comments">; :Examples:</span>
<span class="comments">;   Call the procedure directly::</span>
<span class="comments">;</span>
<span class="comments">;     IDL> test_uniqueness</span>
<span class="comments">;</span>
<span class="comments">; :Author:</span>
<span class="comments">;   Dr. Christiaan Boersma</span>
<span class="comments">;</span>
<span class="comments">; :Copyright:</span>
<span class="comments">;   BSD licensed</span>
<span class="comments">;</span>
<span class="comments">; :History:</span>
<span class="comments">;   Changes::</span>
<span class="comments">;</span>
<span class="comments">;     08-19-2019</span>
<span class="comments">;     Documentation added. Christiaan Boersma.</span>
<span class="comments">;-</span>


<span class="comments">;+</span>
<span class="comments">; Procedure for testing the uniqueness of a number of randomly</span>
<span class="comments">; generate PAH emission spectra.</span>
<span class="comments">;</span>
<span class="comments">; :Categories:</span>
<span class="comments">;   Example</span>
<span class="comments">;-</span>
PRO TEST_UNIQUENESS

  <span class="comments">; avoid underflow messages</span>
  !EXCEPT = 0

  <span class="comments">; set number of spectra to co-add, the FWHM to be applied when</span>
  <span class="comments">; convolving and spectral range</span>
  nspectra = 40

  fwhm = 15D

  xrange = [15D, 2.5D]

  <span class="comments">; read in the default database defined by the environement variable</span>
  <span class="comments">; !AMESPAHDEFAULTDB or the system variable AMESPAHDEFAULTDB. use the</span>
  <span class="comments">; keyword FILENAME if these have not been set</span>
  pahdb = OBJ_NEW('AmesPAHdbIDLSuite')

  <span class="comments">; retrieve all the transitions from the database</span>
  transitions = pahdb->getTransitionsByUID( -1 )

  <span class="comments">; retrieve all unique identifiers</span>
  uids = transitions->getUIDs(nuids)

  <span class="comments">; have every PAH absorb 6 eV</span>
  transitions->Cascade,6D * 1.6021765D-12

  <span class="comments">; convolve the transitions into a spectrum</span>
  spectrum = transitions->Convolve( $
             Xrange=1D4/xrange, $
             FWHM=fwhm, $
             /Gaussian)

  OBJ_DESTROY,transitions

  spectrum_s = spectrum->Get()

  <span class="comments">; run uniqueness test</span>
  niterations = 1000L

  store = REPLICATE({norm: 0D, $
                     anion: 0D, $
                     neutral: 0D, $
                     cation:0D, $
                     small:0D, $
                     large:0D, $
                     pure:0D, $
                     nitrogen: 0D,$
                     solo: 0D, $
                     duo: 0D, $
                     trio: 0D, $
                     quartet: 0D, $
                     quintet: 0D}, niterations)

  ntags = N_TAGS(store)

  selected_weights = REPLICATE({uid:0L, weight:0D}, nspectra)

  indices = LONARR(nspectra, /NOZERO)

  FOR i = 0, niterations - 1 DO BEGIN

     <span class="comments">; print progress</span>
     PRINT,"========================================================="
     PRINT,"        ITERATION: " + STRTRIM(STRING(FORMAT='(I0)', i + 1), 2) + "/" + STRTRIM(STRING(FORMAT='(I0)',  niterations), 2)
     PRINT,"========================================================="

     <span class="comments">; create random selection of unique identifiers and avoid doubles</span>
     n = nspectra

     WHILE n GT 0 DO BEGIN

        indices[nspectra - n] = LONG(RANDOMU(seed, n) * nuids)

        indices = indices[SORT(indices)]

        u = UNIQ(indices)

        n = nspectra - N_ELEMENTS(u)

        indices[0] = indices[u]
     ENDWHILE

     selected_uids = uids[indices]

     <span class="comments">; intersect</span>
     spectrum->Intersect,selected_uids

     <span class="comments">; store data</span>
     data = (spectrum->Get()).data

     <span class="comments">; create random weights</span>
     selected_weights.uid = selected_uids

     selected_weights.weight = 1D14 * RANDOMU(LONG(SYSTIME(1)), nspectra, /DOUBLE)

     <span class="comments">; co-add the spectra using the random weights</span>
     coadd = spectrum->Coadd(Weights=selected_weights)

     <span class="comments">; reset spectrum</span>
     spectrum->Set,spectrum_s

     <span class="comments">; difference</span>
     spectrum->Difference,selected_uids

     <span class="comments">; fit the spectrum</span>
     fit = spectrum->Fit((coadd.Get()).data.intensity)

     OBJ_DESTROY,coadd

     IF OBJ_VALID(fit) THEN BEGIN

       <span class="comments">; breakdown of the fit</span>
       bd_fit = fit->getBreakdown()

       store[i].norm = fit->getNorm()

       <span class="comments">; breakdown of the original spectrum</span>
       FOR j = 0, nspectra - 1 DO BEGIN

          sel1 = WHERE(selected_weights.uid EQ selected_uids[j])

          sel2 = WHERE(data.uid EQ selected_uids[j])

          data[sel2].intensity *= selected_weights[sel1].weight
       ENDFOR

       fit->Set,Data=data,Weights=selected_weights,UIDs=selected_uids

       bd_org = fit->getBreakdown()

       <span class="comments">; store breakdown fractional difference</span>
       FOR j = 0, ntags - 2 DO store[i].(j + 1) = DOUBLE(bd_fit.(j)) / DOUBLE(bd_org.(j))

       <span class="comments">; clean up fit</span>
       OBJ_DESTROY,fit

    ENDIF

    <span class="comments">; reset spectrum</span>
    spectrum->Set,spectrum_s

  ENDFOR

  <span class="comments">; clean up</span>
  OBJ_DESTROY,[spectrum, pahdb]

  <span class="comments">; plot distribution anion</span>
  h = HISTOGRAM(store.anion, LOCATIONS=l, BINSIZE=0.05, /NAN)

  PLOT,l,h,XTITLE='fraction anion correct',YTITLE='frequency [#]',PSYM=10

  key = ''
  IF !D.NAME EQ 'X' THEN READ,key,PROMPT="Press &lt;enter> to continue..."

  <span class="comments">; plot distribution neutral</span>
  h = HISTOGRAM(store.neutral, LOCATIONS=l, BINSIZE=0.05, /NAN)

  PLOT,l,h,XTITLE='fraction neutral correct',YTITLE='frequency [#]',PSYM=10

  IF !D.NAME EQ 'X' THEN READ,key,PROMPT="Press &lt;enter> to continue..."

  <span class="comments">; plot distribution cation</span>
  h = HISTOGRAM(store.cation, LOCATIONS=l, BINSIZE=0.05, /NAN)

  PLOT,l,h,XTITLE='fraction cation correct',YTITLE='frequency [#]',PSYM=10

  IF !D.NAME EQ 'X' THEN READ,key,PROMPT="Press &lt;enter> to continue..."

  <span class="comments">; plot distribution small</span>
  h = HISTOGRAM(store.small, LOCATIONS=l, BINSIZE=0.05, /NAN)

  PLOT,l,h,XTITLE='fraction small correct',YTITLE='frequency [#]',PSYM=10

  IF !D.NAME EQ 'X' THEN READ,key,PROMPT="Press &lt;enter> to continue..."

  <span class="comments">; plot distribution large</span>
  h = HISTOGRAM(store.large, LOCATIONS=l, BINSIZE=0.05, /NAN)

  PLOT,l,h,XTITLE='fraction large correct',YTITLE='frequency [#]',PSYM=10

  IF !D.NAME EQ 'X' THEN READ,key,PROMPT="Press &lt;enter> to continue..."

  <span class="comments">; plot distribution nitrogen</span>
  h = HISTOGRAM(store.nitrogen, LOCATIONS=l, BINSIZE=0.05, /NAN)

  PLOT,l,h,XTITLE='fraction nitrogen correct',YTITLE='frequency [#]',PSYM=10

  IF !D.NAME EQ 'X' THEN READ,key,PROMPT="Press &lt;enter> to continue..."

  <span class="comments">; plot distribution solo</span>
  h = HISTOGRAM(store.solo, LOCATIONS=l, BINSIZE=0.05, /NAN)

  PLOT,l,h,XTITLE='fraction solo correct',YTITLE='frequency [#]',PSYM=10

  IF !D.NAME EQ 'X' THEN READ,key,PROMPT="Press &lt;enter> to continue..."

  <span class="comments">; plot distribution duo</span>
  h = HISTOGRAM(store.duo, LOCATIONS=l, BINSIZE=0.05)

  PLOT,l,h,XTITLE='fraction duo correct',YTITLE='frequency [#]',PSYM=10

  IF !D.NAME EQ 'X' THEN READ,key,PROMPT="Press &lt;enter> to continue..."

  <span class="comments">; plot distribution trio</span>
  h = HISTOGRAM(store.trio, LOCATIONS=l, BINSIZE=0.05, /NAN)

  PLOT,l,h,XTITLE='fraction trio correct',YTITLE='frequency [#]',PSYM=10

  IF !D.NAME EQ 'X' THEN READ,key,PROMPT="Press &lt;enter> to continue..."

END
</code>
      </div>
    </div>
  </body>
</html>